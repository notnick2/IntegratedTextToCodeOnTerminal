#!/bin/bash

spinner() {
  local pid=$1
  local delay=0.15
  local spinstr='|/-\'
  local i=0
  
  while ps -p $pid >/dev/null; do
    i=$(( (i+1) % 4 ))
    printf "[%c] " "${spinstr:$i:1}"
    sleep $delay
    printf "\b\b\b"
  done

  printf "    \b\b\b\b" # Clear the spinner
}

# Function to execute commands
execute_commands() {
  local commands="$1"
  eval "$commands"
}

agent() {
  if [ -z "$1" ]; then
    echo "Usage: agent <prompt>"
    return 1
  fi

  local prompt="$1"
  local server_url="http://localhost:3000/get-commands"

  # Send the prompt to the Express server
  response=$(curl -s -X POST -H "Content-Type: application/json" -d "{\"prompt\":\"$prompt\"}" "$server_url")

  # Parse the JSON response to get the array of commands
  commands=$(echo "$response" | jq -r '.commands | join(";")')
  summary=$(echo "$response" | jq -r '.summary')

  # Print a loading message
  echo -e "Executing commands. Please wait..\n"
  
  # Start the spinner in the background
  spinner $$ &

  # Execute the commands
  execute_commands "$commands"

  # Stop the spinner
  kill $! >/dev/null 2>&1

  # Print a message after execution
  echo -e "\nCommands executed successfully."

  echo "$summary"
}

# Usage example:
# agent "example_prompt"

# Uncomment the line below if you want to execute the function immediately
agent "$1"
